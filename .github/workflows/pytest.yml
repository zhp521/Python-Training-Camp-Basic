name: Pythonæµ‹è¯•

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'exercises/**'
      - 'tests/**'
      - 'requirements.txt'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'è¿è¡ŒåŸå› '
        required: false
        default: 'æ‰‹åŠ¨æµ‹è¯•'

jobs:
  # ç¡®ä¿æµ‹è¯•åªåœ¨éåŸå§‹ä»“åº“è¿è¡Œ
  test:
    # æ·»åŠ æ¡ä»¶ï¼Œåªåœ¨éåŸå§‹ä»“åº“æ‰€æœ‰è€…æ—¶è¿è¡Œ
    if: github.repository_owner != 'PythonTrainingCamp'
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    # è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿UTF-8ç¼–ç 
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      ENCODED_API_URL: "aHR0cHM6Ly9hcGkub3BlbmNhbXAuY24vd2ViL2FwaS9jb3Vyc2VSYW5rL2NyZWF0ZUJ5VGhpcmRUb2tlbg=="
      ENCODED_TOKEN: "ZDFkYTE1ZWU4M2ZkNDg0ZmIxMzliYzNjMDdkOGIxNTk="
      
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.8", "3.9", "3.10"]

    steps:
    - name: è¾“å‡ºè°ƒè¯•ä¿¡æ¯
      run: |
        echo "å½“å‰ä»“åº“: ${{ github.repository }}"
        echo "ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"
        echo "æ¨é€è€…: ${{ github.actor }}"
        echo "åŸå§‹ä»“åº“æ‰€æœ‰è€…: PythonTrainingCamp"
      shell: bash
    
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ¯”è¾ƒæ›´æ”¹

    - name: Decode API URL and Token (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "DECODED_API_URL=$(printf '%s' "$ENCODED_API_URL" | base64 --decode)" >> $GITHUB_ENV
        echo "DECODED_TOKEN=$(printf '%s' "$ENCODED_TOKEN" | base64 --decode)" >> $GITHUB_ENV
        echo "::add-mask::$(printf '%s' "$ENCODED_TOKEN" | base64 --decode)"
      shell: bash

    - name: Decode API URL and Token (Windows)
      if: runner.os == 'Windows'
      run: |
        $decodedUrlBytes = [System.Convert]::FromBase64String("${{ env.ENCODED_API_URL }}")
        $decodedUrl = [System.Text.Encoding]::UTF8.GetString($decodedUrlBytes)
        echo "DECODED_API_URL=$decodedUrl" >> $env:GITHUB_ENV

        $decodedTokenBytes = [System.Convert]::FromBase64String("${{ env.ENCODED_TOKEN }}")
        $decodedToken = [System.Text.Encoding]::UTF8.GetString($decodedTokenBytes)
        echo "DECODED_TOKEN=$decodedToken" >> $env:GITHUB_ENV
        
        echo "::add-mask::$decodedToken"
      shell: pwsh
    
    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest pytest-cov
        python -m pip install -r requirements.txt
      shell: bash
    
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        # ä»…æ£€æŸ¥exercisesç›®å½•ä¸­æäº¤çš„Pythonæ–‡ä»¶
        flake8 exercises --count --select=E9,F63,F7,F82 --show-source --statistics
      shell: bash
    
    - name: è¯†åˆ«ä¿®æ”¹çš„æ–‡ä»¶
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: exercises/**/*.py
    
    - name: è¿è¡Œé’ˆå¯¹å˜æ›´æ–‡ä»¶çš„æµ‹è¯• (Linux)
      if: steps.changed-files.outputs.any_changed == 'true' && runner.os == 'Linux'
      run: |
        echo "ğŸ” æ£€æµ‹åˆ°ä¿®æ”¹çš„æ–‡ä»¶:"
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "  ğŸ“ $file å·²ä¿®æ”¹"
          # ä»æ–‡ä»¶è·¯å¾„æå–æµ‹è¯•æ–‡ä»¶å
          filename=$(basename "$file")
          test_file="tests/test_${filename}"
          if [ -f "$test_file" ]; then
            echo "  ğŸ§ª è¿è¡Œæµ‹è¯•: $test_file"
            python -m pytest "$test_file" -v
          else
            echo "  â“ æ‰¾ä¸åˆ°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶: $test_file"
          fi
        done
      shell: bash
      
    - name: è¿è¡Œé’ˆå¯¹å˜æ›´æ–‡ä»¶çš„æµ‹è¯• (Windows)
      if: steps.changed-files.outputs.any_changed == 'true' && runner.os == 'Windows'
      run: |
        echo "ğŸ” æ£€æµ‹åˆ°ä¿®æ”¹çš„æ–‡ä»¶:"
        foreach($file in "${{ steps.changed-files.outputs.all_changed_files }}".Split()) {
          echo "  ğŸ“ $file å·²ä¿®æ”¹"
          # ä»æ–‡ä»¶è·¯å¾„æå–æµ‹è¯•æ–‡ä»¶å
          $filename = Split-Path $file -Leaf
          $test_file = "tests/test_$filename"
          if (Test-Path $test_file) {
            echo "  ğŸ§ª è¿è¡Œæµ‹è¯•: $test_file"
            python -m pytest $test_file -v
          } else {
            echo "  â“ æ‰¾ä¸åˆ°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶: $test_file"
          }
        }
      shell: pwsh
    
    - name: è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      id: run-all-tests
      run: |
        python -m pytest --cov=exercises tests/ --cov-report=xml -v | tee pytest-output.txt
      shell: bash

    - name: Calculate Score
      id: calculate-score
      run: |
        if grep -q -E "FAILED|ERROR" pytest-output.txt; then
          echo "å‘ç°æµ‹è¯•å¤±è´¥æˆ–é”™è¯¯ã€‚åˆ†æ•°è®¾ç½®ä¸º 0ã€‚"
          echo "score_value=0" >> $GITHUB_OUTPUT
        else
          echo "æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚åˆ†æ•°è®¾ç½®ä¸º 100ã€‚"
          echo "score_value=100" >> $GITHUB_OUTPUT
        fi
      shell: bash
      if: runner.os == 'Linux'

    - name: Calculate Score (Windows)
      id: calculate-score-windows
      run: |
        if (Select-String -Path pytest-output.txt -Pattern "FAILED", "ERROR" -Quiet) {
          Write-Host "å‘ç°æµ‹è¯•å¤±è´¥æˆ–é”™è¯¯ã€‚åˆ†æ•°è®¾ç½®ä¸º 0ã€‚"
          echo "score_value=0" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚åˆ†æ•°è®¾ç½®ä¸º 100ã€‚"
          echo "score_value=100" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
      if: runner.os == 'Windows'
      
    - name: Send Score to OpenCamp API
      # ä»…åœ¨ç‰¹å®šçš„ OS å’Œ Python ç‰ˆæœ¬ç»„åˆä¸Šè¿è¡Œï¼Œå¹¶ä¸”å‰é¢çš„æ­¥éª¤æˆåŠŸ
      if: success() && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      env:
        COURSE_ID: 1799
        SCORE: ${{ steps.calculate-score.outputs.score_value }}
      run: |
        echo "å‡†å¤‡å‘é€åˆ†æ•°åˆ° API..."
        echo "è¯¾ç¨‹ ID: $COURSE_ID"
        echo "æäº¤è€…: $GITHUB_ACTOR"
        echo "è®¡ç®—å¾—åˆ°çš„åˆ†æ•°: $SCORE"
        # ä½¿ç”¨è§£ç åçš„ API URL
        echo "API ç«¯ç‚¹: $DECODED_API_URL"

        if [ -z "$SCORE" ]; then
          echo "é”™è¯¯ï¼šæ— æ³•è·å–è®¡ç®—å¾—åˆ°çš„åˆ†æ•°ã€‚"
          exit 1
        fi
        
        # æ£€æŸ¥è§£ç åçš„å˜é‡æ˜¯å¦å­˜åœ¨ (é˜²å¾¡æ€§ç¼–ç¨‹)
        if [ -z "$DECODED_API_URL" ] || [ -z "$DECODED_TOKEN" ]; then
           echo "é”™è¯¯ï¼šæ— æ³•è·å–è§£ç åçš„ API URL æˆ– Tokenã€‚"
           exit 1
        fi

        JSON_PAYLOAD=$(printf '{"channel": "github", "courseId": %d, "ext": "{}", "name": "%s", "score": %s, "totalScore": 100}' "$COURSE_ID" "$GITHUB_ACTOR" "$SCORE")

        # æ‰“å° JSON æ—¶éšè— Token
        echo "æ„é€ çš„ JSON (Token å·²éšè—): $(printf '{"channel": "github", "courseId": %d, "ext": "{}", "name": "%s", "score": %s, "totalScore": 100}' "$COURSE_ID" "$GITHUB_ACTOR" "$SCORE")"

        echo "Debug Token Check (first 5 chars): [${DECODED_TOKEN:0:5}...]"
        # ------------- è°ƒè¯•è¾“å‡ºç»“æŸ -------------

        # å°† curl å‘½ä»¤æ”¾åœ¨å•è¡Œï¼Œç§»é™¤ '\' ç»­è¡Œç¬¦
        curl -X POST -H 'accept: application/json;charset=utf-8' -H 'Content-Type: application/json' -H "token: $DECODED_TOKEN" -d "$JSON_PAYLOAD" "$DECODED_API_URL" --fail --show-error

        echo "API è°ƒç”¨å°è¯•å®Œæˆã€‚"
      shell: bash # å› ä¸ºæˆ‘ä»¬é™åˆ¶äº†åœ¨ ubuntu ä¸Šè¿è¡Œï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç”¨ bash

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦ (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "### æµ‹è¯•ç»“æœæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        if [ -f pytest-output.txt ]; then
          passed=$(grep -c "PASSED" pytest-output.txt || echo "0")
          failed=$(grep -c "FAILED" pytest-output.txt || echo "0")
          echo "é€šè¿‡çš„æµ‹è¯•: $passed" >> $GITHUB_STEP_SUMMARY
          echo "å¤±è´¥çš„æµ‹è¯•: $failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "[è­¦å‘Š] æœªæ‰¾åˆ°æµ‹è¯•è¾“å‡ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f coverage.xml ]; then
          coverage=$(grep -o "line-rate=\"[0-9.]*\"" coverage.xml | head -1 | grep -o "[0-9.]*" || echo "0")
          if [ ! -z "$coverage" ]; then
            coverage=$(printf "%.1f" $(echo "$coverage * 100" | bc))
            if (( $(echo "$coverage > 80" | bc -l) )); then
              echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (ä¼˜ç§€)" >> $GITHUB_STEP_SUMMARY
            elif (( $(echo "$coverage > 60" | bc -l) )); then
              echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (è‰¯å¥½)" >> $GITHUB_STEP_SUMMARY
            elif (( $(echo "$coverage > 40" | bc -l) )); then
              echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (ä¸€èˆ¬)" >> $GITHUB_STEP_SUMMARY
            else
              echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (éœ€è¦æ”¹è¿›)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "æµ‹è¯•è¦†ç›–ç‡: æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "æµ‹è¯•è¦†ç›–ç‡: æœªç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç»ƒä¹ å®Œæˆæƒ…å†µ" >> $GITHUB_STEP_SUMMARY
        total=0
        passed=0
        for file in exercises/*.py; do
          if [ -f "$file" ]; then
            total=$((total+1))
            filename=$(basename "$file")
            test_file="tests/test_${filename}"
            if [ -f "$test_file" ]; then
              if python -m pytest "$test_file" -v > /dev/null 2>&1; then
                passed=$((passed+1))
                echo "- [é€šè¿‡] $filename" >> $GITHUB_STEP_SUMMARY
              else
                echo "- [æœªé€šè¿‡] $filename" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- [æ— æµ‹è¯•] $filename" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        # è®¡ç®—å®Œæˆåº¦
        if [ $total -ne 0 ]; then
          completion=$(echo "scale=1; $passed * 100 / $total" | bc)
          
          # åˆ›å»ºè¿›åº¦æ¡
          progress_bar=""
          bar_length=20
          filled_length=$(echo "scale=0; $bar_length * $passed / $total" | bc)
          
          # ç¡®ä¿filled_lengthæ˜¯æ•´æ•°
          filled_length=${filled_length%.*}
          
          # é˜²æ­¢é™¤é›¶é”™è¯¯
          if [ -z "$filled_length" ]; then
            filled_length=0
          fi
          
          # æ„å»ºè¿›åº¦æ¡
          for ((i=0; i<$bar_length; i++)); do
            if [ $i -lt $filled_length ]; then
              progress_bar="${progress_bar}#"
            else
              progress_bar="${progress_bar}-"
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## è®­ç»ƒè¥å­¦ä¹ è¿›åº¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®å®Œæˆç™¾åˆ†æ¯”é€‰æ‹©ä¸åŒçš„è¯„ä»·
          if (( $(echo "$completion > 90" | bc -l) )); then
            echo "[ä¼˜ç§€] $progress_bar $completion%" >> $GITHUB_STEP_SUMMARY
            echo "æ­å–œï¼Œæ‚¨å·²ç»å®Œæˆäº†ç»å¤§éƒ¨åˆ†ç»ƒä¹ ï¼Œè¡¨ç°éå¸¸å‡ºè‰²ï¼" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$completion > 70" | bc -l) )); then
            echo "[è‰¯å¥½] $progress_bar $completion%" >> $GITHUB_STEP_SUMMARY
            echo "è¡¨ç°è‰¯å¥½ï¼Œæ‚¨å·²å®Œæˆå¤§éƒ¨åˆ†ç»ƒä¹ ï¼Œç»§ç»­ä¿æŒï¼" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$completion > 50" | bc -l) )); then
            echo "[ä¸­ç­‰] $progress_bar $completion%" >> $GITHUB_STEP_SUMMARY
            echo "å·²ç»å®Œæˆä¸€åŠä»¥ä¸Šçš„ç»ƒä¹ ï¼Œç»§ç»­åŠ æ²¹ï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "[åˆçº§] $progress_bar $completion%" >> $GITHUB_STEP_SUMMARY
            echo "æ‚¨å·²ç»å¼€å§‹å­¦ä¹ ï¼Œåç»­éœ€è¦ç»§ç»­ç»ƒä¹ ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ˜¾ç¤ºå…·ä½“æ•°å­—
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å·²å®Œæˆ: $passed / $total ä¸ªç»ƒä¹ " >> $GITHUB_STEP_SUMMARY
        fi
      shell: bash
      
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦ (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "### æµ‹è¯•ç»“æœæ€»ç»“" >> $env:GITHUB_STEP_SUMMARY
        if (Test-Path pytest-output.txt) {
          $content = Get-Content pytest-output.txt
          $passed = ($content | Select-String "PASSED" -AllMatches).Matches.Count
          $failed = ($content | Select-String "FAILED" -AllMatches).Matches.Count
          echo "é€šè¿‡çš„æµ‹è¯•: $passed" >> $env:GITHUB_STEP_SUMMARY
          echo "å¤±è´¥çš„æµ‹è¯•: $failed" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "[è­¦å‘Š] æœªæ‰¾åˆ°æµ‹è¯•è¾“å‡ºæ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
        }
        
        if (Test-Path coverage.xml) {
          $xml = [xml](Get-Content coverage.xml)
          $coverage = [float]$xml.coverage.LineRate * 100
          $coverage = [math]::Round($coverage, 1)
          if ($coverage -gt 80) {
            echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (ä¼˜ç§€)" >> $env:GITHUB_STEP_SUMMARY
          } elseif ($coverage -gt 60) {
            echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (è‰¯å¥½)" >> $env:GITHUB_STEP_SUMMARY
          } elseif ($coverage -gt 40) {
            echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (ä¸€èˆ¬)" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "æµ‹è¯•è¦†ç›–ç‡: ${coverage}% (éœ€è¦æ”¹è¿›)" >> $env:GITHUB_STEP_SUMMARY
          }
        } else {
          echo "æµ‹è¯•è¦†ç›–ç‡: æœªç”ŸæˆæŠ¥å‘Š" >> $env:GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ç»ƒä¹ å®Œæˆæƒ…å†µ" >> $env:GITHUB_STEP_SUMMARY
        $total = 0
        $passed = 0
        Get-ChildItem exercises -Filter *.py | ForEach-Object {
          $total++
          $filename = $_.Name
          $test_file = "tests/test_$filename"
          if (Test-Path $test_file) {
            $result = python -m pytest $test_file -v 2>&1
            if ($LASTEXITCODE -eq 0) {
              $passed++
              echo "- [é€šè¿‡] $filename" >> $env:GITHUB_STEP_SUMMARY
            } else {
              echo "- [æœªé€šè¿‡] $filename" >> $env:GITHUB_STEP_SUMMARY
            }
          } else {
            echo "- [æ— æµ‹è¯•] $filename" >> $env:GITHUB_STEP_SUMMARY
          }
        }
        
        # è®¡ç®—å®Œæˆåº¦
        if ($total -ne 0) {
          $completion = [math]::Round(($passed * 100 / $total), 1)
          
          # åˆ›å»ºè¿›åº¦æ¡
          $progress_bar = ""
          $bar_length = 20
          $filled_length = [math]::Floor($bar_length * $passed / $total)
          
          # æ„å»ºè¿›åº¦æ¡
          for ($i=0; $i -lt $bar_length; $i++) {
            if ($i -lt $filled_length) {
              $progress_bar = "$progress_bar#"
            } else {
              $progress_bar = "$progress_bar-"
            }
          }
          
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "## è®­ç»ƒè¥å­¦ä¹ è¿›åº¦" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          # æ ¹æ®å®Œæˆç™¾åˆ†æ¯”é€‰æ‹©ä¸åŒçš„è¯„ä»·
          if ($completion -gt 90) {
            echo "[ä¼˜ç§€] $progress_bar $completion%" >> $env:GITHUB_STEP_SUMMARY
            echo "æ­å–œï¼Œæ‚¨å·²ç»å®Œæˆäº†ç»å¤§éƒ¨åˆ†ç»ƒä¹ ï¼Œè¡¨ç°éå¸¸å‡ºè‰²ï¼" >> $env:GITHUB_STEP_SUMMARY
          } elseif ($completion -gt 70) {
            echo "[è‰¯å¥½] $progress_bar $completion%" >> $env:GITHUB_STEP_SUMMARY
            echo "è¡¨ç°è‰¯å¥½ï¼Œæ‚¨å·²å®Œæˆå¤§éƒ¨åˆ†ç»ƒä¹ ï¼Œç»§ç»­ä¿æŒï¼" >> $env:GITHUB_STEP_SUMMARY
          } elseif ($completion -gt 50) {
            echo "[ä¸­ç­‰] $progress_bar $completion%" >> $env:GITHUB_STEP_SUMMARY
            echo "å·²ç»å®Œæˆä¸€åŠä»¥ä¸Šçš„ç»ƒä¹ ï¼Œç»§ç»­åŠ æ²¹ï¼" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "[åˆçº§] $progress_bar $completion%" >> $env:GITHUB_STEP_SUMMARY
            echo "æ‚¨å·²ç»å¼€å§‹å­¦ä¹ ï¼Œåç»­éœ€è¦ç»§ç»­ç»ƒä¹ ã€‚" >> $env:GITHUB_STEP_SUMMARY
          }
          
          # æ˜¾ç¤ºå…·ä½“æ•°å­—
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "å·²å®Œæˆ: $passed / $total ä¸ªç»ƒä¹ " >> $env:GITHUB_STEP_SUMMARY
        }
      shell: pwsh
    
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false 