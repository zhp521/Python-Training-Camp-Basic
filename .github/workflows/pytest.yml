name: PythonåŸºç¡€è®­ç»ƒè¥æµ‹è¯•

on:
  # åˆ é™¤å¯¹PRçš„è§¦å‘
  # pull_request:
  #  branches: [ main, master ]
  #  paths:
  #    - 'exercises/**'
  #    - 'tests/**'
  
  # åœ¨ä»»ä½•ä»£ç æŽ¨é€æ—¶è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - 'exercises/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/pytest.yml'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'è¿è¡ŒåŽŸå› '
        required: false
        default: 'æ‰‹åŠ¨æµ‹è¯•'

jobs:
  # æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿è¡Œæµ‹è¯•
  should-run:
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.check.outputs.should-run-tests }}
    steps:
      - name: èŽ·å–æºä»“åº“ä¿¡æ¯
        id: source-repo
        run: |
          # èŽ·å–åŽŸå§‹ä»“åº“çš„æ‰€æœ‰è€…
          ORIGINAL_OWNER="mozhijiang"
          echo "original_owner=$ORIGINAL_OWNER" >> $GITHUB_OUTPUT
        shell: bash
        
      - name: æ£€æŸ¥æ˜¯å¦åœ¨æºä»“åº“æˆ–forkä»“åº“ä¸­è¿è¡Œ
        id: check
        run: |
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘åˆ™å§‹ç»ˆè¿è¡Œ
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "åŽŸå› : æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œè¿è¡Œæµ‹è¯•"
            exit 0
          fi
          
          # å½“å‰ä»“åº“æ‰€æœ‰è€…
          CURRENT_OWNER="${{ github.repository_owner }}"
          # åŽŸå§‹ä»“åº“æ‰€æœ‰è€…
          ORIGINAL_OWNER="${{ steps.source-repo.outputs.original_owner }}"
          
          echo "å½“å‰ä»“åº“æ‰€æœ‰è€…: $CURRENT_OWNER"
          echo "åŽŸå§‹ä»“åº“æ‰€æœ‰è€…: $ORIGINAL_OWNER"
          
          # æ£€æŸ¥æ˜¯å¦åœ¨forkçš„ä»“åº“ä¸­è¿è¡Œ
          if [ "$CURRENT_OWNER" != "$ORIGINAL_OWNER" ]; then
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "åŽŸå› : åœ¨forkä»“åº“ä¸­è¿è¡Œï¼Œç»§ç»­æµ‹è¯•"
          else
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "åŽŸå› : åœ¨åŽŸå§‹ä»“åº“ä¸­è¿è¡Œï¼Œè·³è¿‡æµ‹è¯•"
          fi
        shell: bash

  # ä¸»æµ‹è¯•ä»»åŠ¡
  test:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    needs: should-run
    if: ${{ needs.should-run.outputs.should-run-tests == 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.8", "3.9", "3.10"]

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿æ¯”è¾ƒæ›´æ”¹
    
    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest pytest-cov
        python -m pip install -r requirements.txt
      shell: bash
    
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        # ä»…æ£€æŸ¥exercisesç›®å½•ä¸­æäº¤çš„Pythonæ–‡ä»¶
        flake8 exercises --count --select=E9,F63,F7,F82 --show-source --statistics
      shell: bash
    
    - name: è¯†åˆ«ä¿®æ”¹çš„æ–‡ä»¶
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: exercises/**/*.py
    
    - name: è¿è¡Œé’ˆå¯¹å˜æ›´æ–‡ä»¶çš„æµ‹è¯• (Linux)
      if: steps.changed-files.outputs.any_changed == 'true' && runner.os == 'Linux'
      run: |
        echo "æ£€æµ‹åˆ°ä¿®æ”¹çš„æ–‡ä»¶:"
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "$file å·²ä¿®æ”¹"
          # ä»Žæ–‡ä»¶è·¯å¾„æå–æµ‹è¯•æ–‡ä»¶å
          filename=$(basename "$file")
          test_file="tests/test_${filename}"
          if [ -f "$test_file" ]; then
            echo "è¿è¡Œæµ‹è¯•: $test_file"
            python -m pytest "$test_file" -v
          else
            echo "æ‰¾ä¸åˆ°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶: $test_file"
          fi
        done
      shell: bash
      
    - name: è¿è¡Œé’ˆå¯¹å˜æ›´æ–‡ä»¶çš„æµ‹è¯• (Windows)
      if: steps.changed-files.outputs.any_changed == 'true' && runner.os == 'Windows'
      run: |
        echo "æ£€æµ‹åˆ°ä¿®æ”¹çš„æ–‡ä»¶:"
        foreach($file in "${{ steps.changed-files.outputs.all_changed_files }}".Split()) {
          echo "$file å·²ä¿®æ”¹"
          # ä»Žæ–‡ä»¶è·¯å¾„æå–æµ‹è¯•æ–‡ä»¶å
          $filename = Split-Path $file -Leaf
          $test_file = "tests/test_$filename"
          if (Test-Path $test_file) {
            echo "è¿è¡Œæµ‹è¯•: $test_file"
            python -m pytest $test_file -v
          } else {
            echo "æ‰¾ä¸åˆ°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶: $test_file"
          }
        }
      shell: pwsh
    
    - name: è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
      run: |
        python -m pytest --cov=exercises tests/ --cov-report=xml -v | tee pytest-output.txt
      shell: bash
    
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦ (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "### æµ‹è¯•ç»“æžœ ðŸ§ª" >> $GITHUB_STEP_SUMMARY
        if [ -f pytest-output.txt ]; then
          passed=$(grep -c "PASSED" pytest-output.txt || echo "0")
          failed=$(grep -c "FAILED" pytest-output.txt || echo "0")
          echo "âœ… é€šè¿‡çš„æµ‹è¯•: $passed" >> $GITHUB_STEP_SUMMARY
          echo "âŒ å¤±è´¥çš„æµ‹è¯•: $failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•è¾“å‡ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f coverage.xml ]; then
          coverage=$(grep -o "line-rate=\"[0-9.]*\"" coverage.xml | head -1 | grep -o "[0-9.]*" || echo "0")
          if [ ! -z "$coverage" ]; then
            coverage=$(printf "%.1f" $(echo "$coverage * 100" | bc))
            echo "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡: ${coverage}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡: æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡: æœªç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å®Œæˆçš„ç»ƒä¹ :" >> $GITHUB_STEP_SUMMARY
        for file in exercises/*.py; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            test_file="tests/test_${filename}"
            if [ -f "$test_file" ]; then
              if python -m pytest "$test_file" -v > /dev/null 2>&1; then
                echo "- âœ… $filename" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âŒ $filename" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- âš ï¸ $filename (æ— æµ‹è¯•æ–‡ä»¶)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
      shell: bash
      
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦ (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "### æµ‹è¯•ç»“æžœ ðŸ§ª" >> $env:GITHUB_STEP_SUMMARY
        if (Test-Path pytest-output.txt) {
          $content = Get-Content pytest-output.txt
          $passed = ($content | Select-String "PASSED" -AllMatches).Matches.Count
          $failed = ($content | Select-String "FAILED" -AllMatches).Matches.Count
          echo "âœ… é€šè¿‡çš„æµ‹è¯•: $passed" >> $env:GITHUB_STEP_SUMMARY
          echo "âŒ å¤±è´¥çš„æµ‹è¯•: $failed" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•è¾“å‡ºæ–‡ä»¶" >> $env:GITHUB_STEP_SUMMARY
        }
        
        if (Test-Path coverage.xml) {
          $xml = [xml](Get-Content coverage.xml)
          $coverage = [float]$xml.coverage.LineRate * 100
          $coverage = [math]::Round($coverage, 1)
          echo "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡: ${coverage}%" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡: æœªç”ŸæˆæŠ¥å‘Š" >> $env:GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### å®Œæˆçš„ç»ƒä¹ :" >> $env:GITHUB_STEP_SUMMARY
        Get-ChildItem exercises -Filter *.py | ForEach-Object {
          $filename = $_.Name
          $test_file = "tests/test_$filename"
          if (Test-Path $test_file) {
            $result = python -m pytest $test_file -v 2>&1
            if ($LASTEXITCODE -eq 0) {
              echo "- âœ… $filename" >> $env:GITHUB_STEP_SUMMARY
            } else {
              echo "- âŒ $filename" >> $env:GITHUB_STEP_SUMMARY
            }
          } else {
            echo "- âš ï¸ $filename (æ— æµ‹è¯•æ–‡ä»¶)" >> $env:GITHUB_STEP_SUMMARY
          }
        }
      shell: pwsh
    
    - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false 